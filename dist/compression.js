"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Compressor;

var _zstream = _interopRequireDefault(require("pako/lib/zlib/zstream"));

var _deflate = require("pako/lib/zlib/deflate");

var _inflate = require("pako/lib/zlib/inflate");

var _messages = _interopRequireDefault(require("pako/lib/zlib/messages.js"));

var _constants = require("pako/lib/zlib/constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const CHUNK_SIZE = 16384;
const WINDOW_BITS = 15;
/**
 * Handles de-/compression via #inflate() and #deflate(), calls you back via #deflatedReady() and #inflatedReady().
 * The chunk we get from deflater is actually a view of a 16kB arraybuffer, so we need to copy the relevant parts
 * memory to a new arraybuffer.
 */

function Compressor(inflatedReady, deflatedReady) {
  this.inflatedReady = inflatedReady;
  this.deflatedReady = deflatedReady;
  this._inflate = inflater(chunk => this.inflatedReady(chunk.buffer.slice(chunk.byteOffset, chunk.byteOffset + chunk.length)));
  this._deflate = deflater(chunk => this.deflatedReady(chunk.buffer.slice(chunk.byteOffset, chunk.byteOffset + chunk.length)));
}

Compressor.prototype.inflate = function (buffer) {
  this._inflate(new Uint8Array(buffer));
};

Compressor.prototype.deflate = function (buffer) {
  this._deflate(new Uint8Array(buffer));
};

function deflater(emit) {
  const stream = new _zstream.default();
  let status = (0, _deflate.deflateInit2)(stream, _constants.Z_DEFAULT_COMPRESSION, _constants.Z_DEFLATED, WINDOW_BITS, 8, _constants.Z_DEFAULT_STRATEGY);

  if (status !== _constants.Z_OK) {
    throw new Error('Problem initializing deflate stream: ' + _messages.default[status]);
  }

  return function (data) {
    if (data === undefined) return emit(); // Attach the input data

    stream.input = data;
    stream.next_in = 0;
    stream.avail_in = stream.input.length;
    let status;
    let output;
    let start;
    let ret = true;

    do {
      // When the stream gets full, we need to create new space.
      if (stream.avail_out === 0) {
        stream.output = new Uint8Array(CHUNK_SIZE);
        start = stream.next_out = 0;
        stream.avail_out = CHUNK_SIZE;
      } // Perform the deflate


      status = (0, _deflate.deflate)(stream, _constants.Z_SYNC_FLUSH);

      if (status !== _constants.Z_STREAM_END && status !== _constants.Z_OK) {
        throw new Error('Deflate problem: ' + _messages.default[status]);
      } // If the output buffer got full, flush the data.


      if (stream.avail_out === 0 && stream.next_out > start) {
        output = stream.output.subarray(start, start = stream.next_out);
        ret = emit(output);
      }
    } while ((stream.avail_in > 0 || stream.avail_out === 0) && status !== _constants.Z_STREAM_END); // Emit whatever is left in output.


    if (stream.next_out > start) {
      output = stream.output.subarray(start, start = stream.next_out);
      ret = emit(output);
    }

    return ret;
  };
}

function inflater(emit) {
  let stream = new _zstream.default();
  const status = (0, _inflate.inflateInit2)(stream, WINDOW_BITS);

  if (status !== _constants.Z_OK) {
    throw new Error('Problem initializing inflate stream: ' + _messages.default[status]);
  }

  return function (data) {
    if (data === undefined) return emit();
    let start;
    stream.input = data;
    stream.next_in = 0;
    stream.avail_in = stream.input.length;
    let status, output;
    let ret = true;

    do {
      if (stream.avail_out === 0) {
        stream.output = new Uint8Array(CHUNK_SIZE);
        start = stream.next_out = 0;
        stream.avail_out = CHUNK_SIZE;
      }

      status = (0, _inflate.inflate)(stream, _constants.Z_NO_FLUSH);

      if (status !== _constants.Z_STREAM_END && status !== _constants.Z_OK) {
        throw new Error('inflate problem: ' + _messages.default[status]);
      }

      if (stream.next_out) {
        if (stream.avail_out === 0 || status === _constants.Z_STREAM_END) {
          output = stream.output.subarray(start, start = stream.next_out);
          ret = emit(output);
        }
      }
    } while (stream.avail_in > 0 && status !== _constants.Z_STREAM_END);

    if (stream.next_out > start) {
      output = stream.output.subarray(start, start = stream.next_out);
      ret = emit(output);
    }

    return ret;
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21wcmVzc2lvbi5qcyJdLCJuYW1lcyI6WyJDSFVOS19TSVpFIiwiV0lORE9XX0JJVFMiLCJDb21wcmVzc29yIiwiaW5mbGF0ZWRSZWFkeSIsImRlZmxhdGVkUmVhZHkiLCJfaW5mbGF0ZSIsImluZmxhdGVyIiwiY2h1bmsiLCJidWZmZXIiLCJzbGljZSIsImJ5dGVPZmZzZXQiLCJsZW5ndGgiLCJfZGVmbGF0ZSIsImRlZmxhdGVyIiwicHJvdG90eXBlIiwiaW5mbGF0ZSIsIlVpbnQ4QXJyYXkiLCJkZWZsYXRlIiwiZW1pdCIsInN0cmVhbSIsIlpTdHJlYW0iLCJzdGF0dXMiLCJaX0RFRkFVTFRfQ09NUFJFU1NJT04iLCJaX0RFRkxBVEVEIiwiWl9ERUZBVUxUX1NUUkFURUdZIiwiWl9PSyIsIkVycm9yIiwibWVzc2FnZXMiLCJkYXRhIiwidW5kZWZpbmVkIiwiaW5wdXQiLCJuZXh0X2luIiwiYXZhaWxfaW4iLCJvdXRwdXQiLCJzdGFydCIsInJldCIsImF2YWlsX291dCIsIm5leHRfb3V0IiwiWl9TWU5DX0ZMVVNIIiwiWl9TVFJFQU1fRU5EIiwic3ViYXJyYXkiLCJaX05PX0ZMVVNIIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFNQSxNQUFNQSxVQUFVLEdBQUcsS0FBbkI7QUFDQSxNQUFNQyxXQUFXLEdBQUcsRUFBcEI7QUFFQTs7Ozs7O0FBS2UsU0FBU0MsVUFBVCxDQUFxQkMsYUFBckIsRUFBb0NDLGFBQXBDLEVBQW1EO0FBQ2hFLE9BQUtELGFBQUwsR0FBcUJBLGFBQXJCO0FBQ0EsT0FBS0MsYUFBTCxHQUFxQkEsYUFBckI7QUFDQSxPQUFLQyxRQUFMLEdBQWdCQyxRQUFRLENBQUNDLEtBQUssSUFBSSxLQUFLSixhQUFMLENBQW1CSSxLQUFLLENBQUNDLE1BQU4sQ0FBYUMsS0FBYixDQUFtQkYsS0FBSyxDQUFDRyxVQUF6QixFQUFxQ0gsS0FBSyxDQUFDRyxVQUFOLEdBQW1CSCxL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OlsiaW1wb3J0IFpTdHJlYW0gZnJvbSAncGFrby9saWIvemxpYi96c3RyZWFtJ1xuaW1wb3J0IHsgZGVmbGF0ZUluaXQyLCBkZWZsYXRlIH0gZnJvbSAncGFrby9saWIvemxpYi9kZWZsYXRlJ1xuaW1wb3J0IHsgaW5mbGF0ZSwgaW5mbGF0ZUluaXQyIH0gZnJvbSAncGFrby9saWIvemxpYi9pbmZsYXRlJ1xuaW1wb3J0IG1lc3NhZ2VzIGZyb20gJ3Bha28vbGliL3psaWIvbWVzc2FnZXMuanMnXG5pbXBvcnQge1xuICBaX05PX0ZMVVNILCBaX1NZTkNfRkxVU0gsIFpfT0ssXG4gIFpfU1RSRUFNX0VORCwgWl9ERUZBVUxUX0NPTVBSRVNTSU9OLFxuICBaX0RFRkFVTFRfU1RSQVRFR1ksIFpfREVGTEFURURcbn0gZnJvbSAncGFrby9saWIvemxpYi9jb25zdGFudHMnXG5cbmNvbnN0IENIVU5LX1NJWkUgPSAxNjM4NFxuY29uc3QgV0lORE9XX0JJVFMgPSAxNVxuXG4vKipcbiAqIEhhbmRsZXMgZGUtL2NvbXByZXNzaW9uIHZpYSAjaW5mbGF0ZSgpIGFuZCAjZGVmbGF0ZSgpLCBjYWxscyB5b3UgYmFjayB2aWEgI2RlZmxhdGVkUmVhZHkoKSBhbmQgI2luZmxhdGVkUmVhZHkoKS5cbiAqIFRoZSBjaHVuayB3ZSBnZXQgZnJvbSBkZWZsYXRlciBpcyBhY3R1YWxseSBhIHZpZXcgb2YgYSAxNmtCIGFycmF5YnVmZmVyLCBzbyB3ZSBuZWVkIHRvIGNvcHkgdGhlIHJlbGV2YW50IHBhcnRzXG4gKiBtZW1vcnkgdG8gYSBuZXcgYXJyYXlidWZmZXIuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIENvbXByZXNzb3IgKGluZmxhdGVkUmVhZHksIGRlZmxhdGVkUmVhZHkpIHtcbiAgdGhpcy5pbmZsYXRlZFJlYWR5ID0gaW5mbGF0ZWRSZWFkeVxuICB0aGlzLmRlZmxhdGVkUmVhZHkgPSBkZWZsYXRlZFJlYWR5XG4gIHRoaXMuX2luZmxhdGUgPSBpbmZsYXRlcihjaHVuayA9PiB0aGlzLmluZmxhdGVkUmVhZHkoY2h1bmsuYnVmZmVyLnNsaWNlKGNodW5rLmJ5dGVPZmZzZXQsIGNodW5rLmJ5dGVPZmZzZXQgKyBjaHVuay5sZW5ndGgpKSlcbiAgdGhpcy5fZGVmbGF0ZSA9IGRlZmxhdGVyKGNodW5rID0+IHRoaXMuZGVmbGF0ZWRSZWFkeShjaHVuay5idWZmZXIuc2xpY2UoY2h1bmsuYnl0ZU9mZnNldCwgY2h1bmsuYnl0ZU9mZnNldCArIGNodW5rLmxlbmd0aCkpKVxufVxuXG5Db21wcmVzc29yLnByb3RvdHlwZS5pbmZsYXRlID0gZnVuY3Rpb24gKGJ1ZmZlcikge1xuICB0aGlzLl9pbmZsYXRlKG5ldyBVaW50OEFycmF5KGJ1ZmZlcikpXG59XG5cbkNvbXByZXNzb3IucHJvdG90eXBlLmRlZmxhdGUgPSBmdW5jdGlvbiAoYnVmZmVyKSB7XG4gIHRoaXMuX2RlZmxhdGUobmV3IFVpbnQ4QXJyYXkoYnVmZmVyKSlcbn1cblxuZnVuY3Rpb24gZGVmbGF0ZXIgKGVtaXQpIHtcbiAgY29uc3Qgc3RyZWFtID0gbmV3IFpTdHJlYW0oKVxuICBsZXQgc3RhdHVzID0gZGVmbGF0ZUluaXQyKHN0cmVhbSwgWl9ERUZBVUxUX0NPTVBSRVNTSU9OLCBaX0RFRkxBVEVELCBXSU5ET1dfQklUUywgOCwgWl9ERUZBVUxUX1NUUkFURUdZKVxuICBpZiAoc3RhdHVzICE9PSBaX09LKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdQcm9ibGVtIGluaXRpYWxpemluZyBkZWZsYXRlIHN0cmVhbTogJyArIG1lc3NhZ2VzW3N0YXR1c10pXG4gIH1cblxuICByZXR1cm4gZnVuY3Rpb24gKGRhdGEpIHtcbiAgICBpZiAoZGF0YSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZW1pdCgpXG5cbiAgICAvLyBBdHRhY2ggdGhlIGlucHV0IGRhdGFcbiAgICBzdHJlYW0uaW5wdXQgPSBkYXRhXG4gICAgc3RyZWFtLm5leHRfaW4gPSAwXG4gICAgc3RyZWFtLmF2YWlsX2luID0gc3RyZWFtLmlucHV0Lmxlbmd0aFxuXG4gICAgbGV0IHN0YXR1c1xuICAgIGxldCBvdXRwdXRcbiAgICBsZXQgc3RhcnRcbiAgICBsZXQgcmV0ID0gdHJ1ZVxuXG4gICAgZG8ge1xuICAgICAgLy8gV2hlbiB0aGUgc3RyZWFtIGdldHMgZnVsbCwgd2UgbmVlZCB0byBjcmVhdGUgbmV3IHNwYWNlLlxuICAgICAgaWYgKHN0cmVhbS5hdmFpbF9vdXQgPT09IDApIHtcbiAgICAgICAgc3RyZWFtLm91dHB1dCA9IG5ldyBVaW50OEFycmF5KENIVU5LX1NJWkUpXG4gICAgICAgIHN0YXJ0ID0gc3RyZWFtLm5leHRfb3V0ID0gMFxuICAgICAgICBzdHJlYW0uYXZhaWxfb3V0ID0gQ0hVTktfU0laRVxuICAgICAgfVxuXG4gICAgICAvLyBQZXJmb3JtIHRoZSBkZWZsYXRlXG4gICAgICBzdGF0dXMgPSBkZWZsYXRlKHN0cmVhbSwgWl9TWU5DX0ZMVVNIKVxuICAgICAgaWYgKHN0YXR1cyAhPT0gWl9TVFJFQU1fRU5EICYmIHN0YXR1cyAhPT0gWl9PSykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RlZmxhdGUgcHJvYmxlbTogJyArIG1lc3NhZ2VzW3N0YXR1c10pXG4gICAgICB9XG5cbiAgICAgIC8vIElmIHRoZSBvdXRwdXQgYnVmZmVyIGdvdCBmdWxsLCBmbHVzaCB0aGUgZGF0YS5cbiAgICAgIGlmIChzdHJlYW0uYXZhaWxfb3V0ID09PSAwICYmIHN0cmVhbS5uZXh0X291dCA+IHN0YXJ0KSB7XG4gICAgICAgIG91dHB1dCA9IHN0cmVhbS5vdXRwdXQuc3ViYXJyYXkoc3RhcnQsIHN0YXJ0ID0gc3RyZWFtLm5leHRfb3V0KVxuICAgICAgICByZXQgPSBlbWl0KG91dHB1dClcbiAgICAgIH1cbiAgICB9IHdoaWxlICgoc3RyZWFtLmF2YWlsX2luID4gMCB8fCBzdHJlYW0uYXZhaWxfb3V0ID09PSAwKSAmJiBzdGF0dXMgIT09IFpfU1RSRUFNX0VORClcblxuICAgIC8vIEVtaXQgd2hhdGV2ZXIgaXMgbGVmdCBpbiBvdXRwdXQuXG4gICAgaWYgKHN0cmVhbS5uZXh0X291dCA+IHN0YXJ0KSB7XG4gICAgICBvdXRwdXQgPSBzdHJlYW0ub3V0cHV0LnN1YmFycmF5KHN0YXJ0LCBzdGFydCA9IHN0cmVhbS5uZXh0X291dClcbiAgICAgIHJldCA9IGVtaXQob3V0cHV0KVxuICAgIH1cbiAgICByZXR1cm4gcmV0XG4gIH1cbn1cblxuZnVuY3Rpb24gaW5mbGF0ZXIgKGVtaXQpIHtcbiAgbGV0IHN0cmVhbSA9IG5ldyBaU3RyZWFtKClcblxuICBjb25zdCBzdGF0dXMgPSBpbmZsYXRlSW5pdDIoc3RyZWFtLCBXSU5ET1dfQklUUylcbiAgaWYgKHN0YXR1cyAhPT0gWl9PSykge1xuICAgIHRocm93IG5ldyBFcnJvcignUHJvYmxlbSBpbml0aWFsaXppbmcgaW5mbGF0ZSBzdHJlYW06ICcgKyBtZXNzYWdlc1tzdGF0dXNdKVxuICB9XG5cbiAgcmV0dXJuIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgaWYgKGRhdGEgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGVtaXQoKVxuXG4gICAgbGV0IHN0YXJ0XG4gICAgc3RyZWFtLmlucHV0ID0gZGF0YVxuICAgIHN0cmVhbS5uZXh0X2luID0gMFxuICAgIHN0cmVhbS5hdmFpbF9pbiA9IHN0cmVhbS5pbnB1dC5sZW5ndGhcblxuICAgIGxldCBzdGF0dXMsIG91dHB1dFxuICAgIGxldCByZXQgPSB0cnVlXG5cbiAgICBkbyB7XG4gICAgICBpZiAoc3RyZWFtLmF2YWlsX291dCA9PT0gMCkge1xuICAgICAgICBzdHJlYW0ub3V0cHV0ID0gbmV3IFVpbnQ4QXJyYXkoQ0hVTktfU0laRSlcbiAgICAgICAgc3RhcnQgPSBzdHJlYW0ubmV4dF9vdXQgPSAwXG4gICAgICAgIHN0cmVhbS5hdmFpbF9vdXQgPSBDSFVOS19TSVpFXG4gICAgICB9XG5cbiAgICAgIHN0YXR1cyA9IGluZmxhdGUoc3RyZWFtLCBaX05PX0ZMVVNIKVxuICAgICAgaWYgKHN0YXR1cyAhPT0gWl9TVFJFQU1fRU5EICYmIHN0YXR1cyAhPT0gWl9PSykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2luZmxhdGUgcHJvYmxlbTogJyArIG1lc3NhZ2VzW3N0YXR1c10pXG4gICAgICB9XG5cbiAgICAgIGlmIChzdHJlYW0ubmV4dF9vdXQpIHtcbiAgICAgICAgaWYgKHN0cmVhbS5hdmFpbF9vdXQgPT09IDAgfHwgc3RhdHVzID09PSBaX1NUUkVBTV9FTkQpIHtcbiAgICAgICAgICBvdXRwdXQgPSBzdHJlYW0ub3V0cHV0LnN1YmFycmF5KHN0YXJ0LCBzdGFydCA9IHN0cmVhbS5uZXh0X291dClcbiAgICAgICAgICByZXQgPSBlbWl0KG91dHB1dClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gd2hpbGUgKChzdHJlYW0uYXZhaWxfaW4gPiAwKSAmJiBzdGF0dXMgIT09IFpfU1RSRUFNX0VORClcblxuICAgIGlmIChzdHJlYW0ubmV4dF9vdXQgPiBzdGFydCkge1xuICAgICAgb3V0cHV0ID0gc3RyZWFtLm91dHB1dC5zdWJhcnJheShzdGFydCwgc3RhcnQgPSBzdHJlYW0ubmV4dF9vdXQpXG4gICAgICByZXQgPSBlbWl0KG91dHB1dClcbiAgICB9XG5cbiAgICByZXR1cm4gcmV0XG4gIH1cbn1cbiJdfQ==